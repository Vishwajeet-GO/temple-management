<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festivals - Temple Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/global.css" rel="stylesheet">
    <style>
        .festival-card {
            transition: transform 0.2s;
            cursor: pointer;
        }

        .festival-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸ›• Temple Management</a>
            <div class="navbar-nav ms-auto flex-row">
                <a href="/" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-house"></i> Home
                </a>
                <button class="btn btn-light btn-sm" onclick="showAddModal()">
                    <i class="bi bi-plus-circle"></i> Add Festival
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Filter Tabs -->
        <ul class="nav nav-pills mb-4" id="festivalTabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="filterFestivals('all', this)">All</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterFestivals('upcoming', this)">Upcoming</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterFestivals('ongoing', this)">Ongoing</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="filterFestivals('completed', this)">Completed</a>
            </li>
        </ul>

        <!-- Festival Cards -->
        <div class="row g-4" id="festivalsGrid">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Loading festivals...</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="festivalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="bi bi-calendar-plus"></i> Add Festival
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="festivalForm">
                    <div class="modal-body">
                        <input type="hidden" id="festivalId">

                        <div class="mb-3">
                            <label class="form-label">Festival Name *</label>
                            <input type="text" class="form-control" id="name" required
                                placeholder="e.g., Diwali, Ganeshotsav, etc.">
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="upcoming">Upcoming</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"
                                placeholder="Add information about the festival (optional)..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Save Festival
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-trash"></i> Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Delete this festival?</p>
                    <input type="hidden" id="deleteId">
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/v1';
        let festivalsData = [];
        let currentFilter = 'all';

        function getToken() { return localStorage.getItem('token'); }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric'
            });
        }

        function getStatusBadge(status) {
            const colors = { 'upcoming': 'warning', 'ongoing': 'success', 'completed': 'secondary' };
            return `<span class="badge bg-${colors[status] || 'primary'}">${status}</span>`;
        }

        async function loadFestivals() {
            try {
                const response = await fetch(API_BASE + '/festivals');
                const data = await response.json();

                if (data.success) {
                    festivalsData = data.data || [];
                    renderGrid();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderGrid() {
            const grid = document.getElementById('festivalsGrid');
            let filtered = festivalsData;

            if (currentFilter !== 'all') {
                filtered = festivalsData.filter(f => f.status === currentFilter);
            }

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted"><p>No festivals found.</p></div>';
                return;
            }

            grid.innerHTML = filtered.map(f => `
                <div class="col-md-6 col-lg-4">
                    <div class="card festival-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>${f.name}</strong>
                            ${getStatusBadge(f.status)}
                        </div>
                        <div class="card-body">
                            <p><i class="bi bi-calendar"></i> ${formatDate(f.start_date)} - ${formatDate(f.end_date)}</p>
                            <p class="text-muted small">${f.description || 'No description'}</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editFestival(${f.ID})">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFestival(${f.ID})">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterFestivals(status, element) {
            currentFilter = status;
            document.querySelectorAll('#festivalTabs .nav-link').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            renderGrid();
        }

        function showAddModal() {
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-calendar-plus"></i> Add Festival';
            document.getElementById('festivalForm').reset();
            document.getElementById('festivalId').value = '';
            new bootstrap.Modal(document.getElementById('festivalModal')).show();
        }

        function editFestival(id) {
            const festival = festivalsData.find(f => f.ID === id);
            if (!festival) return;

            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Festival';
            document.getElementById('festivalId').value = id;
            document.getElementById('name').value = festival.name || '';
            document.getElementById('startDate').value = festival.start_date ? festival.start_date.split('T')[0] : '';
            document.getElementById('endDate').value = festival.end_date ? festival.end_date.split('T')[0] : '';
            document.getElementById('status').value = festival.status || 'upcoming';
            document.getElementById('description').value = festival.description || '';

            new bootstrap.Modal(document.getElementById('festivalModal')).show();
        }

        function deleteFestival(id) {
            document.getElementById('deleteId').value = id;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        async function confirmDelete() {
            const id = document.getElementById('deleteId').value;
            const token = getToken();

            if (!token) { window.location.href = '/login'; return; }

            try {
                const response = await fetch(API_BASE + '/festivals/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                if (response.ok) loadFestivals();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('festivalForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const token = getToken();
            if (!token) { window.location.href = '/login'; return; }

            const id = document.getElementById('festivalId').value;
            const isEdit = !!id;

            const festivalData = {
                name: document.getElementById('name').value,
                start_date: new Date(document.getElementById('startDate').value).toISOString(),
                end_date: new Date(document.getElementById('endDate').value).toISOString(),
                status: document.getElementById('status').value,
                description: document.getElementById('description').value
            };

            try {
                const response = await fetch(API_BASE + '/festivals' + (isEdit ? '/' + id : ''), {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(festivalData)
                });

                bootstrap.Modal.getInstance(document.getElementById('festivalModal')).hide();
                if (response.ok) loadFestivals();
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.addEventListener('DOMContentLoaded', loadFestivals);
    </script>
</body>

</html>