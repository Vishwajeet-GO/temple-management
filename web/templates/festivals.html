<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Festivals - Temple Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/global.css" rel="stylesheet">
    <style>
        body {
            background-image: url('/static/images/temple-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 12, 12, 0.5);
            z-index: -1;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, #6f42c1, #5a32a3) !important;
            padding: 10px 0;
        }

        /* Mobile spacing */
        body {
            padding-bottom: 80px;
        }

        @media (min-width: 992px) {
            body {
                padding-bottom: 20px;
            }
        }

        /* Filter Buttons (Pills) */
        .nav-pills {
            gap: 8px;
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 5px;
            /* Hide scrollbar */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-pills::-webkit-scrollbar {
            display: none;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            padding: 8px 20px;
            color: #5a32a3;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e0e0e0;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(111, 66, 193, 0.3);
        }

        /* Cards */
        .festival-card {
            border: none;
            border-radius: 15px;
            transition: transform 0.2s;
            background: rgb(94, 20, 32);
            box-shadow: 0 2px 8px rgba(100, 105, 4, 0.05);
        }

        .festival-card:hover {
            transform: translateY(-3px);
        }

        /* Status Badges */
        .badge {
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">ðŸ›• Temple Management</a>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-outline-light btn-sm me-2 d-none d-md-block"><i class="bi bi-house"></i>
                    Home</a>
                <button class="btn btn-light btn-sm text-primary fw-bold" onclick="openAddModal()">
                    <i class="bi bi-plus-circle-fill"></i> Add Festival
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-3">

        <!-- Filter Tabs (Fixed) -->
        <div class="d-flex justify-content-center mb-4">
            <div class="nav nav-pills" id="festivalTabs" role="tablist">
                <button class="nav-link active" onclick="filterFestivals('all', this)">All</button>
                <button class="nav-link" onclick="filterFestivals('upcoming', this)">Upcoming</button>
                <button class="nav-link" onclick="filterFestivals('ongoing', this)">Ongoing</button>
                <button class="nav-link" onclick="filterFestivals('completed', this)">Completed</button>
            </div>
        </div>

        <!-- Festival Cards Grid -->
        <div class="row g-3" id="festivalsGrid">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2 text-muted">Loading festivals...</p>
            </div>
        </div>
    </div>

    <!-- Floating Add Button (Mobile) -->
    <button class="btn btn-primary rounded-circle shadow position-fixed d-md-none"
        style="bottom: 80px; right: 20px; width: 56px; height: 56px; z-index: 999; background: linear-gradient(135deg, #6f42c1, #5a32a3); border:none;"
        onclick="openAddModal()">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <a href="/"><i class="bi bi-house"></i><span>Home</span></a>
        <a href="/donate"><i class="bi bi-qr-code"></i><span>Pay</span></a>
        <a href="/festivals" class="active" style="color: #6f42c1;"><i
                class="bi bi-calendar-event"></i><span>Festivals</span></a>
        <a href="/donations"><i class="bi bi-cash-coin"></i><span>History</span></a>
        <a href="/expenses"><i class="bi bi-receipt"></i><span>Expense</span></a>
    </nav>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="festivalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                    <h5 class="modal-title" id="modalTitle">Add Festival</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="festivalForm" onsubmit="saveFestival(event)">
                    <div class="modal-body bg-white">
                        <input type="hidden" id="festivalId">

                        <div class="mb-3">
                            <label class="form-label">Festival Name *</label>
                            <input type="text" class="form-control" id="festivalName" required>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Start Date *</label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">End Date *</label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="festivalStatus">
                                <option value="upcoming">Upcoming</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="festivalDescription" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer bg-white">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center bg-white">
                    <p class="text-dark mb-0">Delete this festival?</p>
                    <input type="hidden" id="deleteId">
                </div>
                <div class="modal-footer justify-content-center bg-white">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete()">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="developer-credit">Developed by <a href="#">Vishwajeet_Yadav</a></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/v1';
        let festivalsData = [];
        let currentFilter = 'all';
        let festivalModal, deleteModal;

        document.addEventListener('DOMContentLoaded', function () {
            festivalModal = new bootstrap.Modal(document.getElementById('festivalModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            loadFestivals();
        });

        // Global functions for HTML onclick attributes
        window.openAddModal = function () {
            document.getElementById('modalTitle').innerText = 'Add Festival';
            document.getElementById('festivalForm').reset();
            document.getElementById('festivalId').value = '';
            festivalModal.show();
        };

        window.filterFestivals = function (status, element) {
            currentFilter = status;
            // Update UI
            document.querySelectorAll('#festivalTabs .nav-link').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');

            // Re-render
            renderGrid();
        };

        function getToken() { return localStorage.getItem('token'); }
        function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }); }

        function getStatusBadge(status) {
            const colors = { 'upcoming': 'warning text-dark', 'ongoing': 'success', 'completed': 'secondary' };
            const icons = { 'upcoming': 'clock', 'ongoing': 'play-circle', 'completed': 'check-circle' };
            const color = colors[status] || 'primary';
            const icon = icons[status] || 'circle';
            return `<span class="badge bg-${color}"><i class="bi bi-${icon} me-1"></i>${status}</span>`;
        }

        async function loadFestivals() {
            try {
                const res = await fetch(API_BASE + '/festivals');
                const json = await res.json();
                if (json.success) {
                    festivalsData = json.data || [];
                    renderGrid();
                }
            } catch (e) { console.error(e); }
        }

        function renderGrid() {
            const grid = document.getElementById('festivalsGrid');
            let filtered = festivalsData;

            if (currentFilter !== 'all') {
                filtered = festivalsData.filter(x => x.status === currentFilter);
            }

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5">No festivals found</div>';
                return;
            }

            grid.innerHTML = filtered.map(x => `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card festival-card h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <strong class="text-dark">${x.name}</strong>
                            ${getStatusBadge(x.status)}
                        </div>
                        <div class="card-body">
                            <p class="text-dark mb-2"><i class="bi bi-calendar-range text-primary"></i> ${formatDate(x.start_date)} - ${formatDate(x.end_date)}</p>
                            <p class="text-muted small mb-0">${x.description || 'No description'}</p>
                        </div>
                        <div class="card-footer bg-white border-0">
                            <button class="btn btn-sm btn-outline-primary" onclick="editFestival(${x.ID})"><i class="bi bi-pencil"></i></button> 
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFestival(${x.ID})"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.editFestival = function (id) {
            const f = festivalsData.find(x => x.ID === id);
            if (!f) return;
            document.getElementById('modalTitle').innerText = 'Edit Festival';
            document.getElementById('festivalId').value = id;
            document.getElementById('festivalName').value = f.name || '';
            document.getElementById('startDate').value = f.start_date ? f.start_date.split('T')[0] : '';
            document.getElementById('endDate').value = f.end_date ? f.end_date.split('T')[0] : '';
            document.getElementById('festivalStatus').value = f.status || 'upcoming';
            document.getElementById('festivalDescription').value = f.description || '';
            festivalModal.show();
        };

        window.deleteFestival = function (id) {
            document.getElementById('deleteId').value = id;
            deleteModal.show();
        };

        window.confirmDelete = async function () {
            const token = getToken();
            if (!token) return window.location.href = '/login';
            await fetch(API_BASE + '/festivals/' + document.getElementById('deleteId').value, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
            deleteModal.hide();
            loadFestivals();
        };

        window.saveFestival = async function (event) {
            event.preventDefault();
            const token = getToken();
            if (!token) return window.location.href = '/login';

            const id = document.getElementById('festivalId').value;
            const data = {
                name: document.getElementById('festivalName').value,
                start_date: new Date(document.getElementById('startDate').value).toISOString(),
                end_date: new Date(document.getElementById('endDate').value).toISOString(),
                status: document.getElementById('festivalStatus').value,
                description: document.getElementById('festivalDescription').value
            };

            const url = API_BASE + '/festivals' + (id ? '/' + id : '');
            const method = id ? 'PUT' : 'POST';

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(data)
            });
            festivalModal.hide();
            loadFestivals();
        };
    </script>
</body>

</html>