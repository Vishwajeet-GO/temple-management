<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <title>Donations - Temple Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="/static/css/global.css" rel="stylesheet">
    <style>
        body {
            background-image: url("/static/images/temple-bg.jpg");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .top-nav {
            background: linear-gradient(135deg, #1b5e20, #2e7d32, #43a047)
        }

        .stat-card.total {
            background: linear-gradient(135deg, #2e7d32, #4caf50)
        }

        .stat-card.entries {
            background: linear-gradient(135deg, #1565c0, #42a5f5)
        }

        .stat-card.paid {
            background: linear-gradient(135deg, #00838f, #26c6da)
        }

        .stat-card.pending {
            background: linear-gradient(135deg, #f9a825, #fdd835);
            color: #333
        }

        .modal-head {
            background: linear-gradient(135deg, #1b5e20, #2e7d32)
        }

        .btn-save {
            background: linear-gradient(135deg, #2e7d32, #4caf50)
        }

        .amount {
            color: #66bb6a
        }

        .search-input:focus {
            border-color: #4caf50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.2)
        }

        .nav-item.active {
            color: #4caf50
        }

        .nav-item.active i {
            filter: drop-shadow(0 3px 6px rgba(76, 175, 80, 0.5))
        }

        .nav-item.active::before {
            background: #4caf50
        }

        .spinner {
            border-top-color: #4caf50
        }

        .festival-select {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid #800c78c2;
            font-size: 14px;
            background: hwb(196 3% 34% / 0.488);
            cursor: pointer;
            min-width: 300px;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }


        .search-wrap {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border-radius: 12px;
            border: 1px solid #a0187a78;
            font-size: 15px;
            background: rgba(4, 42, 49, 0.681);
        }

        .search-input:focus {
            outline: none;
            border-color: #ef5350;
            box-shadow: 0 0 0 3px rgba(239, 83, 80, 0.1);
        }

        #omLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a1a;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center
        }

        .om-r {
            position: absolute;
            top: 50%;
            left: 50%;
            border-radius: 50%;
            border: 2px solid transparent
        }

        .om-r1 {
            width: 80px;
            height: 80px;
            border-top-color: #ff9800;
            border-right-color: #ff9800;
            animation: omS 1.5s linear infinite
        }

        .om-r2 {
            width: 100px;
            height: 100px;
            border-bottom-color: #ffd54f;
            border-left-color: #ffd54f;
            animation: omS 2s linear infinite reverse
        }

        .om-r3 {
            width: 120px;
            height: 120px;
            border-top-color: #9c27b0;
            border-right-color: #9c27b0;
            animation: omS 2.5s linear infinite
        }

        @keyframes omS {
            from {
                transform: translate(-50%, -50%) rotate(0deg)
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg)
            }
        }

        @keyframes omP {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8
            }

            50% {
                transform: scale(1.15);
                opacity: 1
            }
        }
    </style>
</head>

<body>

    <!-- Om Loader -->
    <div id="omLoader">
        <div style="position:relative;width:120px;height:120px;margin-bottom:20px">
            <div class="om-r om-r1"></div>
            <div class="om-r om-r2"></div>
            <div class="om-r om-r3"></div>
            <div
                style="position:absolute;top:23%;left:28%;transform:translate(-50%,-50%);font-size:3rem;color:#ffd54f;animation:omP 2s ease-in-out infinite">
                ॐ</div>
        </div>
    </div>

    <div class="particles" id="particles"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Image Viewer -->
    <div class="img-viewer" id="imgViewer" onclick="closeImgViewer()">
        <button class="img-viewer-close"><i class="fas fa-times"></i></button>
        <img id="imgViewerSrc" src="" alt="Preview">
    </div>

    <!-- Confirm -->
    <div class="confirm-bg" id="confirmBg">
        <div class="confirm-box">
            <div class="confirm-icon"><i class="fas fa-trash-alt"></i></div>
            <h4>Delete Donation?</h4>
            <p>This cannot be undone.</p>
            <div class="confirm-btns">
                <button class="cbtn cancel" onclick="closeConfirm()">Cancel</button>
                <button class="cbtn del" id="confirmDelBtn">Delete</button>
            </div>
        </div>
    </div>

    <div class="main">
        <nav class="top-nav">
            <a href="/" class="brand"><i class="fas fa-gopuram"></i><span> मंदिर दान</span></a>
            <div class="nav-btns">
                <a href="/" class="nav-btn home"><i class="fas fa-home"></i> Home</a>
                <button class="nav-btn add" id="addBtn" onclick="openModal()"><i class="fas fa-plus"></i> Add</button>
            </div>
        </nav>

        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon"><i class="fas fa-indian-rupee-sign"></i></div>
                <div class="stat-value" id="sTotal">₹0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card entries">
                <div class="stat-icon"><i class="fas fa-list-ol"></i></div>
                <div class="stat-value" id="sEntries">0</div>
                <div class="stat-label">Entries</div>
            </div>
            <div class="stat-card paid">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value" id="sPaid">0</div>
                <div class="stat-label">Paid</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-value" id="sPending">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Filter Row: Festival Select + Search -->
        <div class="filter-row">
            <select class="festival-select" id="festivalFilter" onchange="fetchData()">
                <option value="all">All Festivals</option>
            </select>
            <div class="search-wrap">
                <i class="fas fa-search"
                    style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#888"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search donations..."
                    oninput="handleSearch(this.value)" style="padding-left:40px">
            </div>
        </div>

        <div class="table-box">
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Donor</th>
                                <th>Amount</th>
                                <th>Festival</th>
                                <th>Mode</th>
                                <th>Image</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                            <tr>
                                <td colspan="8">
                                    <div class="loading-box">
                                        <div class="spinner"></div>
                                        <div class="loading-text">Loading...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-bg" id="modalBg">
        <div class="modal">
            <div class="modal-head">
                <h3><i class="fas fa-hand-holding-heart"></i> <span id="modalTitle">Add Donation</span></h3>
                <button class="modal-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="fg"><label>Festival</label>
                    <select class="fi" id="fFestival">
                        <option value="0">-- No Festival --</option>
                    </select>
                </div>
                <div class="frow">
                    <div class="fg"><label>Date <span class="req">*</span></label><input type="date" class="fi"
                            id="fDate"></div>
                    <div class="fg"><label>Status</label><select class="fi" id="fStatus">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                        </select></div>
                </div>
                <div class="fg"><label>Donor Name <span class="req">*</span></label><input type="text" class="fi"
                        id="fDonor" placeholder="Enter donor name"></div>
                <div class="fg"><label>Amount (₹) <span class="req">*</span></label><input type="number" class="fi"
                        id="fAmount" placeholder="Enter amount" step="0.01" min="0"></div>
                <div class="fg">
                    <label>Payment Screenshot</label>
                    <div class="file-input-wrap">
                        <span id="fileName" class="file-name" style="margin-left: 10px; color: #888;">Choose
                            file...</span>
                        <input type="file" id="fImage" accept="image/*" capture="environment"
                            onchange="previewFile(this)">
                    </div>
                    <div class="file-preview" id="filePreview"><img id="filePreviewImg" src="" alt="Preview"></div>
                </div>
                <div class="fg"><label>Payment Mode</label>
                    <select class="fi" id="fMode">
                        <option value="cash">Cash</option>
                        <option value="upi">UPI</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cheque">Cheque</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-cancel" onclick="closeModal()"><i class="fas fa-times"></i> Cancel</button>
                <button class="btn btn-save" onclick="saveDonation()"><i class="fas fa-save"></i> <span
                        id="saveText">Save</span></button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="/" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="/donate" class="nav-item"><i class="fas fa-heart"></i><span>Donate</span></a>
        <a href="/festivals" class="nav-item"><i class="fas fa-calendar-alt"></i><span>Festivals</span></a>
        <a href="/donations" class="nav-item active"><i class="fas fa-indian-rupee-sign"></i><span>History</span></a>
        <a href="/expenses" class="nav-item"><i class="fas fa-file-invoice-dollar"></i><span>Expenses</span></a>
    </nav>

    <script>

        // Om Loader - Hide after page loads
        window.addEventListener('load', function () {
            setTimeout(function () {
                var el = document.getElementById('omLoader');
                if (el) el.style.display = 'none';
            }, 600);
        });

        const API = window.location.origin + '/api/v1';
        let searchTimer = null, deleteId = null, isAdmin = false, festivals = [];

        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDate(); checkAuth(); loadFestivals(); fetchData();
        });

        function setDefaultDate() { document.getElementById('fDate').value = new Date().toISOString().split('T')[0] }

        async function checkAuth() {
            const t = localStorage.getItem('authToken');
            if (!t) { document.getElementById('addBtn').style.display = 'none'; return }
            try {
                const r = await fetch(`${API}/auth/check`, { headers: { 'Authorization': 'Bearer ' + t } });
                const res = await r.json();
                console.log('Auth check response:', res);
                if (res.authenticated && res.user.role === 'admin') {
                    isAdmin = true;
                    document.getElementById('addBtn').style.display = 'flex';
                    updateNavForAdmin();
                }
                else { document.getElementById('addBtn').style.display = 'none' }
            } catch (e) {
                console.error('Auth check error:', e);
                document.getElementById('addBtn').style.display = 'none'
            }
        }

        function updateNavForAdmin() {
            // Add to top nav
            const navBtnContainer = document.querySelector('.nav-btns');
            if (navBtnContainer && !navBtnContainer.querySelector('a[href="/admin"]')) {
                const adminBtn = document.createElement('a');
                adminBtn.href = '/admin';
                adminBtn.className = 'nav-btn';
                adminBtn.style.background = 'linear-gradient(135deg, #1a237e, #3949ab)';
                adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Admin';
                navBtnContainer.insertBefore(adminBtn, navBtnContainer.firstChild);
            }

            // Add to bottom nav
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav && !bottomNav.querySelector('a[href="/admin"]')) {
                const adminLink = document.createElement('a');
                adminLink.href = '/admin';
                adminLink.className = 'nav-item';
                adminLink.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                bottomNav.appendChild(adminLink);
            }
        }

        async function loadFestivals() {
            try {
                const r = await fetch(`${API}/festivals`); const res = await r.json();
                if (res.success) {
                    festivals = res.data || [];
                    const sel = document.getElementById('festivalFilter');
                    const msel = document.getElementById('fFestival');
                    festivals.forEach(f => {
                        sel.innerHTML += `<option value="${f.id}">${f.name}</option>`;
                        msel.innerHTML += `<option value="${f.id}">${f.name}</option>`;
                    });
                }
            } catch (e) { console.error(e) }
        }

        async function fetchData() {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '<tr><td colspan="8"><div class="loading-box"><div class="spinner"></div><div class="loading-text">Loading...</div></div></td></tr>';
            try {
                const search = document.getElementById('searchInput').value.trim();
                const fid = document.getElementById('festivalFilter').value;
                let url = `${API}/donations?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (fid && fid !== 'all') url += `festival_id=${fid}&`;
                const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const res = await r.json(); if (!res.success) throw new Error(res.error || 'Failed');
                updateStats(res.stats); renderTable(res.data || []);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>${e.message}</p><button class="retry-btn" onclick="fetchData()"><i class="fas fa-redo"></i> Retry</button></div></td></tr>`;
            }
        }

        function updateStats(s) {
            if (!s) return;
            document.getElementById('sTotal').textContent = '₹' + fmt(s.total || 0);
            document.getElementById('sEntries').textContent = s.entries || 0;
            document.getElementById('sPaid').textContent = s.paid || 0;
            document.getElementById('sPending').textContent = s.pending || 0;
        }

        function renderTable(data) {
            const tbody = document.getElementById('tbody');
            if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No donations found</p></div></td></tr>'; return }
            tbody.innerHTML = data.map((d, i) => `
            <tr style="animation-delay:${i * 0.04}s">
                <td>${fmtDate(d.date)}</td>
                <td><strong>${esc(d.donor || '-')}</strong></td>
                <td><span class="amount">₹${fmt(d.amount)}</span></td>
                <td><small>${d.festival ? esc(d.festival.name) : '—'}</small></td>
                <td><span class="payment-mode">${esc(d.payment_mode || 'cash')}</span></td>
                <td>${d.image_url ? `<img src="${d.image_url}" class="img-thumb" onclick="viewImage('${d.image_url}')">` : '—'}</td>
                <td><span class="status-badge ${d.status}" onclick="${isAdmin ? `toggleStatus(${d.id})` : 'void(0)'}">${d.status === 'paid' ? '✓ Paid' : '⏳ Pending'}</span></td>
                <td><div class="action-btns">
                    ${d.image_url ? `<button class="action-btn view" onclick="viewImage('${d.image_url}')"><i class="fas fa-eye"></i></button>` : ''}
                    <button class="action-btn edit ${isAdmin ? '' : 'disabled'}" onclick="editItem(${d.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete ${isAdmin ? '' : 'disabled'}" onclick="showConfirm(${d.id})"><i class="fas fa-trash"></i></button>
                </div></td>
            </tr>`).join('');
        }

        function handleSearch(v) { clearTimeout(searchTimer); searchTimer = setTimeout(() => fetchData(), 400) }

        function viewImage(url) { document.getElementById('imgViewerSrc').src = url; document.getElementById('imgViewer').classList.add('active') }
        function closeImgViewer() { document.getElementById('imgViewer').classList.remove('active') }

        function previewFile(input) {
            const prev = document.getElementById('filePreview'), img = document.getElementById('filePreviewImg');
            if (input.files && input.files[0]) {
                document.getElementById('fileName').textContent = input.files[0].name;
                const r = new FileReader(); r.onload = e => { img.src = e.target.result; prev.style.display = 'block' }; r.readAsDataURL(input.files[0])
            }
            else { prev.style.display = 'none'; document.getElementById('fileName').textContent = 'Choose file...' }
        }

        function openModal() {
            ['editId', 'fDonor', 'fAmount'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('fStatus').value = 'pending'; document.getElementById('fMode').value = 'cash';
            document.getElementById('fFestival').value = '0'; document.getElementById('fImage').value = '';
            document.getElementById('filePreview').style.display = 'none'; document.getElementById('fileName').textContent = 'Choose file...';
            document.getElementById('modalTitle').textContent = 'Add Donation'; document.getElementById('saveText').textContent = 'Save';
            setDefaultDate(); document.getElementById('modalBg').classList.add('active');
            setTimeout(() => document.getElementById('fDonor').focus(), 300);
        }
        function closeModal() { document.getElementById('modalBg').classList.remove('active') }

        async function editItem(id) {
            try {
                const r = await fetch(`${API}/donations`); const res = await r.json();
                const d = (res.data || []).find(x => x.id === id); if (!d) { toast('Not found', 'error'); return }
                document.getElementById('editId').value = d.id; document.getElementById('fDate').value = d.date || '';
                document.getElementById('fDonor').value = d.donor || ''; document.getElementById('fAmount').value = d.amount || '';
                document.getElementById('fStatus').value = d.status || 'pending'; document.getElementById('fMode').value = d.payment_mode || 'cash';
                document.getElementById('fFestival').value = d.festival_id || '0';
                document.getElementById('modalTitle').textContent = 'Edit Donation'; document.getElementById('saveText').textContent = 'Update';
                if (d.image_url) { document.getElementById('filePreviewImg').src = d.image_url; document.getElementById('filePreview').style.display = 'block' }
                document.getElementById('modalBg').classList.add('active');
            } catch (e) { toast('Error: ' + e.message, 'error') }
        }

        async function saveDonation() {
            const editId = document.getElementById('editId').value;
            const donor = document.getElementById('fDonor').value.trim();
            const amount = parseFloat(document.getElementById('fAmount').value);
            if (!donor) { toast('Enter donor name', 'error'); return }
            if (!amount || amount <= 0) { toast('Enter valid amount', 'error'); return }

            const fd = new FormData();
            fd.append('date', document.getElementById('fDate').value);
            fd.append('donor', donor); fd.append('amount', amount);
            fd.append('status', document.getElementById('fStatus').value);
            fd.append('payment_mode', document.getElementById('fMode').value);
            fd.append('festival_id', document.getElementById('fFestival').value);
            const fi = document.getElementById('fImage');
            if (fi.files && fi.files[0]) fd.append('image', fi.files[0]);

            try {
                const token = localStorage.getItem('authToken') || '';
                let url = `${API}/donations`, method = 'POST';
                if (editId) { url += `/${editId}`; method = 'PUT' }

                console.log(`Sending ${method} request to ${url}...`);

                const r = await fetch(url, {
                    method,
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: fd
                });

                if (!r.ok) {
                    const errTxt = await r.text();
                    console.error('Server error:', errTxt);
                    throw new Error(`HTTP ${r.status}: ${errTxt}`);
                }

                const res = await r.json();
                if (!res.success) throw new Error(res.error || 'Failed');

                toast(res.message || 'Saved!', 'success');
                closeModal();
                fetchData();
            } catch (e) {
                console.error('Save error:', e);
                toast('Error: ' + e.message, 'error');
            }
        }

        async function toggleStatus(id) {
            try {
                const t = localStorage.getItem('authToken') || '';
                const r = await fetch(`${API}/donations/${id}/toggle`, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + t } });
                const res = await r.json(); if (!res.success) throw new Error(res.error);
                toast(res.message || 'Updated', 'info'); fetchData();
            } catch (e) { toast('Error: ' + e.message, 'error') }
        }

        function showConfirm(id) {
            deleteId = id; document.getElementById('confirmBg').classList.add('active');
            document.getElementById('confirmDelBtn').onclick = () => deleteItem()
        }
        function closeConfirm() { document.getElementById('confirmBg').classList.remove('active'); deleteId = null }
        async function deleteItem() {
            if (!deleteId) return;
            try {
                const t = localStorage.getItem('authToken') || '';
                const r = await fetch(`${API}/donations/${deleteId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + t } });
                const res = await r.json(); if (!res.success) throw new Error(res.error);
                toast('Deleted', 'success'); closeConfirm(); fetchData();
            } catch (e) { toast('Error: ' + e.message, 'error'); closeConfirm() }
        }

        function toast(m, t = 'info') {
            const b = document.getElementById('toastContainer'); const e = document.createElement('div'); e.className = `toast ${t}`;
            const i = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
            e.innerHTML = `<i class="fas fa-${i[t]}"></i> ${m}`; b.appendChild(e); setTimeout(() => e.classList.add('show'), 10);
            setTimeout(() => { e.classList.remove('show'); setTimeout(() => e.remove(), 400) }, 3000)
        }

        function fmt(n) { return Number(n || 0).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) }
        function fmtDate(d) { if (!d) return '-'; try { return new Date(d).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) } catch { return d } }
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML }

        document.getElementById('modalBg').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal() });
        document.getElementById('confirmBg').addEventListener('click', e => { if (e.target === e.currentTarget) closeConfirm() });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); closeConfirm(); closeImgViewer() } });
    </script>
</body>

</html>